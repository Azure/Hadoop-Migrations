{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.3.255.40792",
      "templateHash": "7157143892321963183"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location to create all resources"
      }
    },
    "projectName": {
      "type": "string",
      "defaultValue": "hdmp001",
      "metadata": {
        "description": "Project name"
      }
    }
  },
  "functions": [],
  "variables": {
    "vLocation": "[parameters('location')]",
    "vProjectName": "[parameters('projectName')]",
    "vVNetName": "[format('{0}vnet001', variables('vProjectName'))]",
    "vNSGName": "[format('{0}nsg001', variables('vProjectName'))]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "create-vnet-and-nsg",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[variables('vLocation')]"
          },
          "VNetName": {
            "value": "[variables('vVNetName')]"
          },
          "addressSpacePrefix": {
            "value": "10.0.0.0/16"
          },
          "subnet1Name": {
            "value": "subnet1"
          },
          "subnet1Prefix": {
            "value": "10.0.1.0/24"
          },
          "subnet2Name": {
            "value": "subnet2"
          },
          "subnet2Prefix": {
            "value": "10.0.2.0/24"
          },
          "subnet3Name": {
            "value": "subnet3"
          },
          "subnet3Prefix": {
            "value": "10.0.3.0/24"
          },
          "networkSecurityGroupName": {
            "value": "[variables('vNSGName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.3.255.40792",
              "templateHash": "5494768620998793190"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location of the resources"
              }
            },
            "VNetName": {
              "type": "string",
              "defaultValue": "vnet001",
              "metadata": {
                "description": "Name for the VNet"
              }
            },
            "addressSpacePrefix": {
              "type": "string",
              "defaultValue": "10.0.0.0/16",
              "metadata": {
                "description": "Address Space Prefix of the VNet"
              }
            },
            "subnet1Name": {
              "type": "string",
              "defaultValue": "subnet1",
              "metadata": {
                "description": "Name of the Subnet1"
              }
            },
            "subnet1Prefix": {
              "type": "string",
              "defaultValue": "10.0.1.0/24",
              "metadata": {
                "description": "Address Prefix of the Subnet1"
              }
            },
            "subnet2Name": {
              "type": "string",
              "defaultValue": "subnet2",
              "metadata": {
                "description": "Name of the Subnet2"
              }
            },
            "subnet2Prefix": {
              "type": "string",
              "defaultValue": "10.0.2.0/24",
              "metadata": {
                "description": "Address Prefix of the Subnet2"
              }
            },
            "subnet3Name": {
              "type": "string",
              "defaultValue": "subnet3",
              "metadata": {
                "description": "Name of the Subnet3"
              }
            },
            "subnet3Prefix": {
              "type": "string",
              "defaultValue": "10.0.3.0/24",
              "metadata": {
                "description": "Address Prefix of the Subnet3"
              }
            },
            "networkSecurityGroupName": {
              "type": "string",
              "defaultValue": "nsg001",
              "metadata": {
                "description": "Network Security Group Name for all subnets"
              }
            }
          },
          "functions": [],
          "variables": {
            "privateEndpointNetworkPolicies": "Disabled",
            "networkSecurityGroupId": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('networkSecurityGroupName'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Network/virtualNetworks",
              "apiVersion": "2020-05-01",
              "name": "[parameters('VNetName')]",
              "location": "[parameters('location')]",
              "properties": {
                "addressSpace": {
                  "addressPrefixes": [
                    "[parameters('addressSpacePrefix')]"
                  ]
                },
                "subnets": [
                  {
                    "name": "[parameters('subnet1Name')]",
                    "properties": {
                      "addressPrefix": "[parameters('subnet1Prefix')]",
                      "privateEndpointNetworkPolicies": "[variables('privateEndpointNetworkPolicies')]",
                      "networkSecurityGroup": {
                        "id": "[variables('networkSecurityGroupId')]"
                      }
                    }
                  },
                  {
                    "name": "[parameters('subnet2Name')]",
                    "properties": {
                      "addressPrefix": "[parameters('subnet2Prefix')]",
                      "privateEndpointNetworkPolicies": "[variables('privateEndpointNetworkPolicies')]",
                      "networkSecurityGroup": {
                        "id": "[variables('networkSecurityGroupId')]"
                      }
                    }
                  },
                  {
                    "name": "[parameters('subnet3Name')]",
                    "properties": {
                      "addressPrefix": "[parameters('subnet3Prefix')]",
                      "privateEndpointNetworkPolicies": "[variables('privateEndpointNetworkPolicies')]",
                      "networkSecurityGroup": {
                        "id": "[variables('networkSecurityGroupId')]"
                      }
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'create-network-security-group')]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "create-network-security-group",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "nsgName": {
                    "value": "[parameters('networkSecurityGroupName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.3.255.40792",
                      "templateHash": "16747326829757680806"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]",
                      "metadata": {
                        "description": "Location of the resources"
                      }
                    },
                    "nsgName": {
                      "type": "string",
                      "defaultValue": "nsg01",
                      "metadata": {
                        "description": "Network Security Group Name"
                      }
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Network/networkSecurityGroups",
                      "apiVersion": "2020-06-01",
                      "name": "[parameters('nsgName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "securityRules": [
                          {
                            "name": "SSH",
                            "properties": {
                              "priority": 1000,
                              "protocol": "Tcp",
                              "access": "Allow",
                              "direction": "Inbound",
                              "sourceAddressPrefix": "*",
                              "sourcePortRange": "*",
                              "destinationAddressPrefix": "*",
                              "destinationPortRange": "22"
                            }
                          }
                        ]
                      }
                    }
                  ]
                }
              }
            }
          ],
          "outputs": {
            "outputmessage": {
              "type": "string",
              "value": "[format('{0} creation done successfully', parameters('VNetName'))]"
            }
          }
        }
      }
    },
    {
      "copy": {
        "name": "stgHeads",
        "count": "[length(range(0, 3))]"
      },
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "[format('create-head-node{0}', range(0, 3)[copyIndex()])]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[variables('vLocation')]"
          },
          "projectName": {
            "value": "[variables('vProjectName')]"
          },
          "keyString": {
            "value": "[reference(resourceId('Microsoft.Compute/sshPublicKeys', 'DEFAULT01'), '2020-12-01').publicKey]"
          },
          "identifier": {
            "value": "[range(0, 3)[copyIndex()]]"
          },
          "suffix": {
            "value": "[format('head{0}', range(0, 3)[copyIndex()])]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.3.255.40792",
              "templateHash": "9733500474596145978"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location to create all resources"
              }
            },
            "projectName": {
              "type": "string",
              "defaultValue": "hdmp001",
              "metadata": {
                "description": "Project name"
              }
            },
            "keyString": {
              "type": "string"
            },
            "identifier": {
              "type": "int"
            },
            "suffix": {
              "type": "string"
            },
            "tmpString": {
              "type": "string",
              "defaultValue": "[utcNow('yyyyMMddHHmmss')]"
            }
          },
          "functions": [],
          "variables": {
            "vLocation": "[parameters('location')]",
            "vProjectName": "[parameters('projectName')]",
            "vKeyString": "[parameters('keyString')]",
            "vVNetName": "[format('{0}vnet001', variables('vProjectName'))]",
            "vNSGName": "[format('{0}nsg001', variables('vProjectName'))]",
            "uniqueString": "[parameters('tmpString')]",
            "VMName": "[toLower(format('{0}{1}-{2}', variables('vProjectName'), parameters('suffix'), variables('uniqueString')))]",
            "diskName": "[toLower(format('{0}-disk{1}', variables('VMName'), variables('uniqueString')))]"
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "[format('create-disk-{0}', parameters('suffix'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[variables('vLocation')]"
                  },
                  "diskName": {
                    "value": "[variables('diskName')]"
                  },
                  "diskSizeGB": {
                    "value": 5
                  },
                  "diskSKU": {
                    "value": "Premium_LRS"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.3.255.40792",
                      "templateHash": "7642844370108994584"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]",
                      "metadata": {
                        "description": "Location of the resources"
                      }
                    },
                    "diskName": {
                      "type": "string",
                      "defaultValue": "disk01",
                      "metadata": {
                        "description": "Name of the Disk"
                      }
                    },
                    "diskSizeGB": {
                      "type": "int",
                      "defaultValue": 4,
                      "metadata": {
                        "description": "Size in GB of the Disk"
                      }
                    },
                    "diskSKU": {
                      "type": "string",
                      "defaultValue": "Premium_LRS",
                      "metadata": {
                        "description": "SKU of the Disk"
                      }
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Compute/disks",
                      "apiVersion": "2020-12-01",
                      "name": "[parameters('diskName')]",
                      "location": "[parameters('location')]",
                      "sku": {
                        "name": "[parameters('diskSKU')]"
                      },
                      "properties": {
                        "creationData": {
                          "createOption": "Empty"
                        },
                        "diskSizeGB": "[parameters('diskSizeGB')]"
                      }
                    }
                  ]
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "[format('create-node-{0}', parameters('suffix'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[variables('vLocation')]"
                  },
                  "vmName": {
                    "value": "[variables('VMName')]"
                  },
                  "authenticationType": {
                    "value": "sshPublicKey"
                  },
                  "adminPasswordOrKey": {
                    "value": "[variables('vKeyString')]"
                  },
                  "virtualNetworkName": {
                    "value": "[variables('vVNetName')]"
                  },
                  "subnetName": {
                    "value": "subnet1"
                  },
                  "networkSecurityGroupName": {
                    "value": "[variables('vNSGName')]"
                  },
                  "ubuntuOSVersion": {
                    "value": "16.04.0-LTS"
                  },
                  "vmSize": {
                    "value": "Standard_B2s"
                  },
                  "dataDiskName": {
                    "value": "[variables('diskName')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.3.255.40792",
                      "templateHash": "1613025154447363405"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]",
                      "metadata": {
                        "description": "Location for the resources"
                      }
                    },
                    "vmName": {
                      "type": "string",
                      "defaultValue": "vm001",
                      "metadata": {
                        "description": "The name of you Virtual Machine."
                      }
                    },
                    "adminUsername": {
                      "type": "string",
                      "defaultValue": "azureuser",
                      "metadata": {
                        "description": "Username for the Virtual Machine."
                      }
                    },
                    "authenticationType": {
                      "type": "string",
                      "defaultValue": "password",
                      "metadata": {
                        "description": "Type of authentication to use on the Virtual Machine. SSH key is recommended."
                      },
                      "allowedValues": [
                        "sshPublicKey",
                        "password"
                      ]
                    },
                    "adminPasswordOrKey": {
                      "type": "secureString",
                      "metadata": {
                        "description": "SSH Key or password for the Virtual Machine. SSH key is recommended."
                      }
                    },
                    "dnsLabelPrefix": {
                      "type": "string",
                      "defaultValue": "[toLower(format('{0}-{1}', parameters('vmName'), uniqueString(resourceGroup().id)))]",
                      "metadata": {
                        "description": "Unique DNS Name for the Public IP used to access the Virtual Machine."
                      }
                    },
                    "ubuntuOSVersion": {
                      "type": "string",
                      "defaultValue": "18.04-LTS",
                      "metadata": {
                        "description": "The Ubuntu version for the VM. This will pick a fully patched image of this given Ubuntu version."
                      },
                      "allowedValues": [
                        "12.04.5-LTS",
                        "14.04.5-LTS",
                        "16.04.0-LTS",
                        "18.04-LTS"
                      ]
                    },
                    "vmSize": {
                      "type": "string",
                      "defaultValue": "Standard_B2s",
                      "metadata": {
                        "description": "The size of the VM"
                      }
                    },
                    "virtualNetworkName": {
                      "type": "string",
                      "defaultValue": "vNet",
                      "metadata": {
                        "description": "Name of the VNET"
                      }
                    },
                    "subnetName": {
                      "type": "string",
                      "defaultValue": "Subnet",
                      "metadata": {
                        "description": "Name of the subnet in the virtual network"
                      }
                    },
                    "networkSecurityGroupName": {
                      "type": "string",
                      "defaultValue": "SecGroupNet",
                      "metadata": {
                        "description": "Name of the Network Security Group"
                      }
                    },
                    "dataDiskName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the Data Disk to attach"
                      }
                    }
                  },
                  "functions": [],
                  "variables": {
                    "publicIpAddressName_var": "[format('{0}-ip', parameters('vmName'))]",
                    "networkInterfaceName_var": "[format('{0}-nic', parameters('vmName'))]",
                    "subnetRef": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('virtualNetworkName'), parameters('subnetName'))]",
                    "osDiskType": "Standard_LRS",
                    "dataDiskId": "[resourceId('Microsoft.Compute/disks', parameters('dataDiskName'))]",
                    "linuxConfiguration": {
                      "disablePasswordAuthentication": true,
                      "ssh": {
                        "publicKeys": [
                          {
                            "path": "[format('/home/{0}/.ssh/authorized_keys', parameters('adminUsername'))]",
                            "keyData": "[parameters('adminPasswordOrKey')]"
                          }
                        ]
                      }
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/networkInterfaces",
                      "apiVersion": "2020-06-01",
                      "name": "[variables('networkInterfaceName_var')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "ipConfigurations": [
                          {
                            "name": "ipconfig1",
                            "properties": {
                              "subnet": {
                                "id": "[variables('subnetRef')]"
                              },
                              "privateIPAllocationMethod": "Dynamic",
                              "publicIPAddress": {
                                "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpAddressName_var'))]"
                              }
                            }
                          }
                        ],
                        "networkSecurityGroup": {
                          "id": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('networkSecurityGroupName'))]"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpAddressName_var'))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Network/publicIPAddresses",
                      "apiVersion": "2020-06-01",
                      "name": "[variables('publicIpAddressName_var')]",
                      "location": "[parameters('location')]",
                      "sku": {
                        "name": "Basic"
                      },
                      "properties": {
                        "publicIPAllocationMethod": "Dynamic",
                        "publicIPAddressVersion": "IPv4",
                        "dnsSettings": {
                          "domainNameLabel": "[parameters('dnsLabelPrefix')]"
                        },
                        "idleTimeoutInMinutes": 4
                      }
                    },
                    {
                      "type": "Microsoft.Compute/virtualMachines",
                      "apiVersion": "2020-06-01",
                      "name": "[parameters('vmName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "hardwareProfile": {
                          "vmSize": "[parameters('vmSize')]"
                        },
                        "storageProfile": {
                          "osDisk": {
                            "createOption": "FromImage",
                            "managedDisk": {
                              "storageAccountType": "[variables('osDiskType')]"
                            }
                          },
                          "dataDisks": [
                            {
                              "lun": 0,
                              "createOption": "Attach",
                              "managedDisk": {
                                "id": "[variables('dataDiskId')]"
                              }
                            }
                          ],
                          "imageReference": {
                            "publisher": "Canonical",
                            "offer": "UbuntuServer",
                            "sku": "[parameters('ubuntuOSVersion')]",
                            "version": "latest"
                          }
                        },
                        "networkProfile": {
                          "networkInterfaces": [
                            {
                              "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('networkInterfaceName_var'))]"
                            }
                          ]
                        },
                        "osProfile": {
                          "computerName": "[parameters('vmName')]",
                          "adminUsername": "[parameters('adminUsername')]",
                          "adminPassword": "[parameters('adminPasswordOrKey')]",
                          "linuxConfiguration": "[if(equals(parameters('authenticationType'), 'password'), json('null'), variables('linuxConfiguration'))]"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/networkInterfaces', variables('networkInterfaceName_var'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "outputmessage": {
                      "type": "string",
                      "value": "[format('{0} creation done successfully', parameters('vmName'))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', format('create-disk-{0}', parameters('suffix')))]"
              ]
            }
          ]
        }
      }
    },
    {
      "copy": {
        "name": "stgWorkers",
        "count": "[length(range(0, 2))]"
      },
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "[format('create-worker-node{0}', range(0, 2)[copyIndex()])]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[variables('vLocation')]"
          },
          "projectName": {
            "value": "[variables('vProjectName')]"
          },
          "keyString": {
            "value": "[reference(resourceId('Microsoft.Compute/sshPublicKeys', 'DEFAULT01'), '2020-12-01').publicKey]"
          },
          "identifier": {
            "value": "[range(0, 2)[copyIndex()]]"
          },
          "suffix": {
            "value": "[format('wrkr{0}', range(0, 2)[copyIndex()])]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.3.255.40792",
              "templateHash": "9733500474596145978"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location to create all resources"
              }
            },
            "projectName": {
              "type": "string",
              "defaultValue": "hdmp001",
              "metadata": {
                "description": "Project name"
              }
            },
            "keyString": {
              "type": "string"
            },
            "identifier": {
              "type": "int"
            },
            "suffix": {
              "type": "string"
            },
            "tmpString": {
              "type": "string",
              "defaultValue": "[utcNow('yyyyMMddHHmmss')]"
            }
          },
          "functions": [],
          "variables": {
            "vLocation": "[parameters('location')]",
            "vProjectName": "[parameters('projectName')]",
            "vKeyString": "[parameters('keyString')]",
            "vVNetName": "[format('{0}vnet001', variables('vProjectName'))]",
            "vNSGName": "[format('{0}nsg001', variables('vProjectName'))]",
            "uniqueString": "[parameters('tmpString')]",
            "VMName": "[toLower(format('{0}{1}-{2}', variables('vProjectName'), parameters('suffix'), variables('uniqueString')))]",
            "diskName": "[toLower(format('{0}-disk{1}', variables('VMName'), variables('uniqueString')))]"
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "[format('create-disk-{0}', parameters('suffix'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[variables('vLocation')]"
                  },
                  "diskName": {
                    "value": "[variables('diskName')]"
                  },
                  "diskSizeGB": {
                    "value": 5
                  },
                  "diskSKU": {
                    "value": "Premium_LRS"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.3.255.40792",
                      "templateHash": "7642844370108994584"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]",
                      "metadata": {
                        "description": "Location of the resources"
                      }
                    },
                    "diskName": {
                      "type": "string",
                      "defaultValue": "disk01",
                      "metadata": {
                        "description": "Name of the Disk"
                      }
                    },
                    "diskSizeGB": {
                      "type": "int",
                      "defaultValue": 4,
                      "metadata": {
                        "description": "Size in GB of the Disk"
                      }
                    },
                    "diskSKU": {
                      "type": "string",
                      "defaultValue": "Premium_LRS",
                      "metadata": {
                        "description": "SKU of the Disk"
                      }
                    }
                  },
                  "functions": [],
                  "resources": [
                    {
                      "type": "Microsoft.Compute/disks",
                      "apiVersion": "2020-12-01",
                      "name": "[parameters('diskName')]",
                      "location": "[parameters('location')]",
                      "sku": {
                        "name": "[parameters('diskSKU')]"
                      },
                      "properties": {
                        "creationData": {
                          "createOption": "Empty"
                        },
                        "diskSizeGB": "[parameters('diskSizeGB')]"
                      }
                    }
                  ]
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2019-10-01",
              "name": "[format('create-node-{0}', parameters('suffix'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[variables('vLocation')]"
                  },
                  "vmName": {
                    "value": "[variables('VMName')]"
                  },
                  "authenticationType": {
                    "value": "sshPublicKey"
                  },
                  "adminPasswordOrKey": {
                    "value": "[variables('vKeyString')]"
                  },
                  "virtualNetworkName": {
                    "value": "[variables('vVNetName')]"
                  },
                  "subnetName": {
                    "value": "subnet1"
                  },
                  "networkSecurityGroupName": {
                    "value": "[variables('vNSGName')]"
                  },
                  "ubuntuOSVersion": {
                    "value": "16.04.0-LTS"
                  },
                  "vmSize": {
                    "value": "Standard_B2s"
                  },
                  "dataDiskName": {
                    "value": "[variables('diskName')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.3.255.40792",
                      "templateHash": "1613025154447363405"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]",
                      "metadata": {
                        "description": "Location for the resources"
                      }
                    },
                    "vmName": {
                      "type": "string",
                      "defaultValue": "vm001",
                      "metadata": {
                        "description": "The name of you Virtual Machine."
                      }
                    },
                    "adminUsername": {
                      "type": "string",
                      "defaultValue": "azureuser",
                      "metadata": {
                        "description": "Username for the Virtual Machine."
                      }
                    },
                    "authenticationType": {
                      "type": "string",
                      "defaultValue": "password",
                      "metadata": {
                        "description": "Type of authentication to use on the Virtual Machine. SSH key is recommended."
                      },
                      "allowedValues": [
                        "sshPublicKey",
                        "password"
                      ]
                    },
                    "adminPasswordOrKey": {
                      "type": "secureString",
                      "metadata": {
                        "description": "SSH Key or password for the Virtual Machine. SSH key is recommended."
                      }
                    },
                    "dnsLabelPrefix": {
                      "type": "string",
                      "defaultValue": "[toLower(format('{0}-{1}', parameters('vmName'), uniqueString(resourceGroup().id)))]",
                      "metadata": {
                        "description": "Unique DNS Name for the Public IP used to access the Virtual Machine."
                      }
                    },
                    "ubuntuOSVersion": {
                      "type": "string",
                      "defaultValue": "18.04-LTS",
                      "metadata": {
                        "description": "The Ubuntu version for the VM. This will pick a fully patched image of this given Ubuntu version."
                      },
                      "allowedValues": [
                        "12.04.5-LTS",
                        "14.04.5-LTS",
                        "16.04.0-LTS",
                        "18.04-LTS"
                      ]
                    },
                    "vmSize": {
                      "type": "string",
                      "defaultValue": "Standard_B2s",
                      "metadata": {
                        "description": "The size of the VM"
                      }
                    },
                    "virtualNetworkName": {
                      "type": "string",
                      "defaultValue": "vNet",
                      "metadata": {
                        "description": "Name of the VNET"
                      }
                    },
                    "subnetName": {
                      "type": "string",
                      "defaultValue": "Subnet",
                      "metadata": {
                        "description": "Name of the subnet in the virtual network"
                      }
                    },
                    "networkSecurityGroupName": {
                      "type": "string",
                      "defaultValue": "SecGroupNet",
                      "metadata": {
                        "description": "Name of the Network Security Group"
                      }
                    },
                    "dataDiskName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the Data Disk to attach"
                      }
                    }
                  },
                  "functions": [],
                  "variables": {
                    "publicIpAddressName_var": "[format('{0}-ip', parameters('vmName'))]",
                    "networkInterfaceName_var": "[format('{0}-nic', parameters('vmName'))]",
                    "subnetRef": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('virtualNetworkName'), parameters('subnetName'))]",
                    "osDiskType": "Standard_LRS",
                    "dataDiskId": "[resourceId('Microsoft.Compute/disks', parameters('dataDiskName'))]",
                    "linuxConfiguration": {
                      "disablePasswordAuthentication": true,
                      "ssh": {
                        "publicKeys": [
                          {
                            "path": "[format('/home/{0}/.ssh/authorized_keys', parameters('adminUsername'))]",
                            "keyData": "[parameters('adminPasswordOrKey')]"
                          }
                        ]
                      }
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/networkInterfaces",
                      "apiVersion": "2020-06-01",
                      "name": "[variables('networkInterfaceName_var')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "ipConfigurations": [
                          {
                            "name": "ipconfig1",
                            "properties": {
                              "subnet": {
                                "id": "[variables('subnetRef')]"
                              },
                              "privateIPAllocationMethod": "Dynamic",
                              "publicIPAddress": {
                                "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpAddressName_var'))]"
                              }
                            }
                          }
                        ],
                        "networkSecurityGroup": {
                          "id": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('networkSecurityGroupName'))]"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpAddressName_var'))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Network/publicIPAddresses",
                      "apiVersion": "2020-06-01",
                      "name": "[variables('publicIpAddressName_var')]",
                      "location": "[parameters('location')]",
                      "sku": {
                        "name": "Basic"
                      },
                      "properties": {
                        "publicIPAllocationMethod": "Dynamic",
                        "publicIPAddressVersion": "IPv4",
                        "dnsSettings": {
                          "domainNameLabel": "[parameters('dnsLabelPrefix')]"
                        },
                        "idleTimeoutInMinutes": 4
                      }
                    },
                    {
                      "type": "Microsoft.Compute/virtualMachines",
                      "apiVersion": "2020-06-01",
                      "name": "[parameters('vmName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "hardwareProfile": {
                          "vmSize": "[parameters('vmSize')]"
                        },
                        "storageProfile": {
                          "osDisk": {
                            "createOption": "FromImage",
                            "managedDisk": {
                              "storageAccountType": "[variables('osDiskType')]"
                            }
                          },
                          "dataDisks": [
                            {
                              "lun": 0,
                              "createOption": "Attach",
                              "managedDisk": {
                                "id": "[variables('dataDiskId')]"
                              }
                            }
                          ],
                          "imageReference": {
                            "publisher": "Canonical",
                            "offer": "UbuntuServer",
                            "sku": "[parameters('ubuntuOSVersion')]",
                            "version": "latest"
                          }
                        },
                        "networkProfile": {
                          "networkInterfaces": [
                            {
                              "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('networkInterfaceName_var'))]"
                            }
                          ]
                        },
                        "osProfile": {
                          "computerName": "[parameters('vmName')]",
                          "adminUsername": "[parameters('adminUsername')]",
                          "adminPassword": "[parameters('adminPasswordOrKey')]",
                          "linuxConfiguration": "[if(equals(parameters('authenticationType'), 'password'), json('null'), variables('linuxConfiguration'))]"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/networkInterfaces', variables('networkInterfaceName_var'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "outputmessage": {
                      "type": "string",
                      "value": "[format('{0} creation done successfully', parameters('vmName'))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', format('create-disk-{0}', parameters('suffix')))]"
              ]
            }
          ]
        }
      }
    }
  ]
}